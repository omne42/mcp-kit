#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

staged_files="$(git diff --cached --name-only --diff-filter=ACMRD || true)"
if [[ -z "${staged_files//[[:space:]]/}" ]]; then
  exit 0
fi

has_changelog=0
other_count=0
needs_mdbook=0
while IFS= read -r path; do
  [[ -z "$path" ]] && continue
  if [[ "$path" == "CHANGELOG.md" ]]; then
    has_changelog=1
  elif [[ "$path" == docs/* ]]; then
    needs_mdbook=1
    other_count=$((other_count + 1))
  else
    other_count=$((other_count + 1))
  fi
done <<<"$staged_files"

if [[ "$has_changelog" -ne 1 ]]; then
  cat >&2 <<'EOF'
pre-commit: CHANGELOG.md must be updated in the same commit.

- Add an entry under [Unreleased] in CHANGELOG.md.
- Stage it: git add CHANGELOG.md
EOF
  exit 1
fi

if [[ "$other_count" -eq 0 ]]; then
  echo "pre-commit: refusing changelog-only commit; commit the actual change together with CHANGELOG.md." >&2
  exit 1
fi

if [[ "${MCP_KIT_ALLOW_CHANGELOG_RELEASE_EDIT:-}" != "1" ]]; then
  head_changelog="$(git show HEAD:CHANGELOG.md 2>/dev/null || true)"
  index_changelog="$(git show :CHANGELOG.md 2>/dev/null || true)"

  if [[ -n "${head_changelog}" && -n "${index_changelog}" ]]; then
    head_released="$(printf '%s\n' "${head_changelog}" | awk 'BEGIN{s=0} /^## \\[[0-9]/{s=1} s{print}')"
    index_released="$(printf '%s\n' "${index_changelog}" | awk 'BEGIN{s=0} /^## \\[[0-9]/{s=1} s{print}')"

    if [[ "${head_released}" != "${index_released}" ]]; then
      cat >&2 <<'EOF'
pre-commit: refusing to modify released CHANGELOG sections.

Only edit entries under [Unreleased]. Released version sections (e.g. [0.x.y]) are immutable.

If you are cutting a release and intentionally updating versioned sections, re-run with:
  MCP_KIT_ALLOW_CHANGELOG_RELEASE_EDIT=1 git commit ...
EOF
      exit 1
    fi
  fi
fi

if [[ -x "$repo_root/scripts/gen-llms-txt.sh" ]]; then
  echo "pre-commit: checking llms.txt bundle" >&2
  (cd "$repo_root" && ./scripts/gen-llms-txt.sh --check) >/dev/null
fi

if [[ -x "$repo_root/scripts/check-rust-hygiene.sh" ]]; then
  echo "pre-commit: checking staged rust hygiene" >&2
  (cd "$repo_root" && ./scripts/check-rust-hygiene.sh)
fi

if [[ "$needs_mdbook" -eq 1 && -f "$repo_root/docs/book.toml" ]]; then
  if command -v mdbook >/dev/null 2>&1; then
    echo "pre-commit: building docs (mdbook)" >&2
    (cd "$repo_root" && mdbook build docs) >/dev/null
  else
    echo "pre-commit: mdbook not found; skipping docs build." >&2
  fi
fi

workspace_root=""
if [[ -f "$repo_root/Cargo.toml" ]]; then
  workspace_root="$repo_root"
fi

if [[ -z "$workspace_root" ]]; then
  echo "pre-commit: no Cargo workspace found; skipping rust fmt/check." >&2
  exit 0
fi

echo "pre-commit: running Rust gates in $workspace_root" >&2

(
  cd "$workspace_root"
  cargo fmt --all -- --check
  cargo clippy --workspace --all-targets --all-features -- -D warnings -W clippy::redundant_clone -W clippy::needless_pass_by_ref_mut
  cargo test --workspace --all-features --quiet
)
